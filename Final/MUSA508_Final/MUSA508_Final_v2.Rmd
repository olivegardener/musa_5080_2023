---
title: "MUSA508_Final"
author: "Oliver Atwood, Dave Drennan"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages}

library(tidyverse)
library(tidycensus)
library(sf)
library(spdep)
library(kableExtra)
library(caret)
library(knitr) 
library(pscl)
library(plotROC)
library(pROC)
library(lubridate)
library(gridExtra)
library(cowplot)
library(raster)
library(sp)
library(ggcorrplot)
library(FNN)
library(ggcorrplot)
library(RSocrata)
library(viridis)
library(stringr)
library(ggtext)


source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

options(scipen = 999)

census_api_key("e13d5be5cb48d927009e0dca0af99d21918d514f")

palette2 <- c("grey70","#D1462F")
palette3 <- c("#C94337", "#f7f7f7", "#5c9b5c")

ileast <- "epsg:3435"

output_dir <- "Data/images/"

```

# Introduction

## Motivation

Here at inspectate, we pride ourselves on data-driven solutions that support municipal food safety and health inspections departments in the United States. Our mission statement is to help consumers eat safely, inspectors prioritize efficiently, and businesses stay open. 

We start with Chicago and plan to use this as a case study to acquire funding to expand for new cities...

## Use Case

We plan to build an app to support health inspectors and restaurant owners...

# Data

## Sources 

Chicago Open Data

```{r inspections data}

inspections_all <- read_csv("Data/Food_Inspections_-_7_1_2018_-_Present.csv")

inspections_all$date <- mdy(inspections_all$`Inspection Date`)
inspections_all$year <- year(inspections_all$date)
inspections_all$quarter <- quarter(inspections_all$date)
```

```{r train and test inspections data}

# for model 
inspections <- inspections_all %>%
  rename(insp_type = "Inspection Type",
         facility_type = "Facility Type",
         license_num = "License #") %>%
  mutate(fail_numeric = case_when(Results == "Pass" ~ 0,
                   Results == "Pass w/ Conditions" ~ 0,
                   Results != "Pass" ~ 1),
         fail = case_when(Results == "Pass" ~ "No",
                   Results == "Pass w/ Conditions" ~ "No",
                   Results != "Pass" ~ "Yes"),
         facility_type = tolower(facility_type)
         ) %>%
  dplyr::filter(year == 2021 | year == 2022 | year == 2023,
                Results != "No Entry" & Results != "Out of Business" & Results != "Not Ready",
                is.na(Location) == FALSE,
                is.na(Risk) == FALSE,
                insp_type == "Canvass")

# exploratory for largest categories of facility types
# typeCount <- inspections %>%
#   group_by(facility_type) %>%
#   summarize(count = n())

inspections <- inspections %>%
  mutate(facility_type = case_when(facility_type == "restaurant" ~ "Restaurant",
                                   facility_type == "school" ~ "School",
                                   facility_type == "grocery store" ~ "Grocery_Store",
                                   facility_type == "children's services facility" ~ "Child_Services_Facility",
                                   facility_type == "long term care" ~ "Long_Term_Care",
                                   .default = "Other"))

# exploratory to confirm largest categories of facility types
# typeCount <- inspections %>%
#   group_by(facility_type) %>%
#   summarize(count = n())


inspections <- inspections %>%
  st_as_sf(coords = c("Longitude", "Latitude")) %>%
  st_set_crs(4326) %>%
  st_transform(ileast)

# neighborhoods
neighborhoods <- st_read("Data/neighborhoods.shp") %>%
  st_transform(ileast)

inspections <- inspections %>%
  st_join(., neighborhoods) %>%
  dplyr::select(-sec_neigh, -shape_area, -shape_len)%>%
  rename(neighborhood = "pri_neigh")

```

```{r prior inspection failures}

# for pre2022 number of failed inspections
inspections_pre2022 <- inspections_all %>%
  rename(insp_type = "Inspection Type",
         facility_type = "Facility Type",
         license_num = "License #") %>%
  mutate(fail_numeric = case_when(Results == "Pass" ~ 0,
                   Results == "Pass w/ Conditions" ~ 0,
                   Results != "Pass" ~ 1),
         fail = case_when(Results == "Pass" ~ "No",
                   Results == "Pass w/ Conditions" ~ "No",
                   Results != "Pass" ~ "Yes"),
         facility_type = tolower(facility_type)
         ) %>%
  dplyr::filter(year < 2022,
                Results != "No Entry" & Results != "Out of Business" & Results != "Not Ready",
                is.na(Location) == FALSE,
                is.na(Risk) == FALSE,
                insp_type == "Canvass") %>%
  mutate(facility_type = case_when(facility_type == "restaurant" ~ "Restaurant",
                                   facility_type == "school" ~ "School",
                                   facility_type == "grocery store" ~ "Grocery_Store",
                                   facility_type == "children's services facility" ~ "Child_Services_Facility",
                                   facility_type == "long term care" ~ "Long_Term_Care",
                                   .default = "Other")) %>%
  dplyr::select(license_num, date, year, quarter, fail_numeric, fail) %>%
  group_by(license_num) %>%
  summarize(prior_fails = sum(fail_numeric))

# for pre2023 number of failed inspections
inspections_pre2023 <- inspections_all %>%
  rename(insp_type = "Inspection Type",
         facility_type = "Facility Type",
         license_num = "License #") %>%
  mutate(fail_numeric = case_when(Results == "Pass" ~ 0,
                   Results == "Pass w/ Conditions" ~ 0,
                   Results != "Pass" ~ 1),
         fail = case_when(Results == "Pass" ~ "No",
                   Results == "Pass w/ Conditions" ~ "No",
                   Results != "Pass" ~ "Yes"),
         facility_type = tolower(facility_type)
         ) %>%
  dplyr::filter(year < 2023,
                Results != "No Entry" & Results != "Out of Business" & Results != "Not Ready",
                is.na(Location) == FALSE,
                is.na(Risk) == FALSE,
                insp_type == "Canvass") %>%
  mutate(facility_type = case_when(facility_type == "restaurant" ~ "Restaurant",
                                   facility_type == "school" ~ "School",
                                   facility_type == "grocery store" ~ "Grocery_Store",
                                   facility_type == "children's services facility" ~ "Child_Services_Facility",
                                   facility_type == "long term care" ~ "Long_Term_Care",
                                   .default = "Other")) %>%
  dplyr::select(license_num, date, year, quarter, fail_numeric, fail) %>%
  group_by(license_num) %>%
  summarize(prior_fails = sum(fail_numeric))

```

```{r raster data}
# Read the infrared data file
summer_thermal <- raster('Data/Landsat9_Thermal_Composite_Chicago.tif')
winter_thermal <- raster('Data/Landsat9_Thermal_Composite2_Chicago.tif')
pop_raster <- raster('Data/Pop_2020_Chicago.tif')


summer_thermal <- projectRaster(from = summer_thermal, crs = "+init=epsg:3435")
winter_thermal <- projectRaster(from = winter_thermal, crs = "+init=epsg:3435")
pop_raster <- projectRaster(from = pop_raster, crs = "+init=epsg:3435")

# Summer Thermal
# Extract raster values
extracted_values <- raster::extract(summer_thermal, inspections)
# Add the extracted values to the 'inspections' dataset
inspections$summer <- extracted_values

# Winter Thermal
extracted_values <- raster::extract(winter_thermal, inspections)
inspections$winter <- extracted_values

# Population
extracted_values <- raster::extract(pop_raster, inspections)
inspections$popdensity <- extracted_values

```

```{r chicago data}

# 311 data

# rats calls
rats <- read_csv("Data/Data_311/rodent_baiting_rat_complaints.csv") %>%
  dplyr::filter(is.na(LOCATION) != TRUE,
                STATUS != "Canceled",
                DUPLICATE == "FALSE") %>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE")) %>%
  st_set_crs(4326) %>%
  mutate(date = mdy_hms(CREATED_DATE)) %>%
  mutate(year = year(date)) %>%
  filter(year == 2021 | year == 2022) %>%
  dplyr::select(year, geometry) %>%
  st_transform(ileast)

rats2021 <- rats %>%
  filter(year == 2021) %>%
  dplyr::select(geometry)

rats2022 <- rats %>%
  filter(year == 2022) %>%
  dplyr::select(geometry)


# building calls
building_violations <- read_csv("Data/Data_311/building_violations.csv")
plumbing_violations <- read_csv("Data/Data_311/buildings_plumbing_violations.csv")
permit_construction_violations <- read_csv("Data/Data_311/no_building_permits_construction_violations.csv")
vacant_abandoned_complaints <- read_csv("Data/Data_311/vacant_abandoned_building_complaints.csv")

building <- rbind(building_violations, plumbing_violations, permit_construction_violations, vacant_abandoned_complaints) %>%
  dplyr::filter(is.na(LOCATION) != TRUE,
                STATUS != "Canceled",
                DUPLICATE == "FALSE") %>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE")) %>%
  st_set_crs(4326) %>%
  mutate(date = mdy_hms(CREATED_DATE)) %>%
  mutate(year = year(date)) %>%
  filter(year == 2021 | year == 2022) %>%
  dplyr::select(year, geometry) %>%
  st_transform(ileast)

building2021 <- building %>%
  filter(year == 2021) %>%
  dplyr::select(geometry)

building2022 <- building %>%
  filter(year == 2022) %>%
  dplyr::select(geometry)

# sanitation violation calls
sanitation <- read_csv("Data/Data_311/sanitation_code_violations.csv") %>%
  dplyr::filter(is.na(LOCATION) != TRUE,
                STATUS != "Canceled",
                DUPLICATE == "FALSE") %>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE")) %>%
  st_set_crs(4326) %>%
  mutate(date = mdy_hms(CREATED_DATE)) %>%
  mutate(year = year(date)) %>%
  filter(year == 2021 | year == 2022) %>%
  dplyr::select(year, geometry) %>%
  st_transform(ileast)

sanitation2021 <- sanitation %>%
  filter(year == 2021) %>%
  dplyr::select(geometry)

sanitation2022 <- sanitation %>%
  filter(year == 2022) %>%
  dplyr::select(geometry)

# flooding calls
water_basement <- read_csv("Data/Data_311/water_in_basement_complaints.csv")
water_street <- read_csv("Data/Data_311/water_on_street_complaints.csv")

flooding <- rbind(water_basement, water_street) %>%
  dplyr::filter(is.na(LOCATION) != TRUE,
                STATUS != "Canceled",
                DUPLICATE == "FALSE") %>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE")) %>%
  st_set_crs(4326) %>%
  mutate(date = mdy_hms(CREATED_DATE)) %>%
  mutate(year = year(date)) %>%
  filter(year == 2021 | year == 2022) %>%
  dplyr::select(year, geometry) %>%
  st_transform(ileast)

flooding2021 <- flooding %>%
  filter(year == 2021) %>%
  dplyr::select(geometry)

flooding2022 <- flooding %>%
  filter(year == 2022) %>%
  dplyr::select(geometry)

# water user calls
low_water_pressure <- read_csv("Data/Data_311/low_water_pressure_complaints.csv")
no_water <- read_csv("Data/Data_311/no_water_complaints.csv")
water_quality_concern <- read_csv("Data/Data_311/water_quality_concern.csv")

water <- rbind(low_water_pressure, no_water, water_quality_concern) %>%
  dplyr::filter(is.na(LOCATION) != TRUE,
                STATUS != "Canceled",
                DUPLICATE == "FALSE") %>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE")) %>%
  st_set_crs(4326) %>%
  mutate(date = mdy_hms(CREATED_DATE)) %>%
  mutate(year = year(date)) %>%
  filter(year == 2021 | year == 2022) %>%
  dplyr::select(year, geometry) %>%
  st_transform(ileast)

water2021 <- water %>%
  filter(year == 2021) %>%
  dplyr::select(geometry)

water2022 <- water %>%
  filter(year == 2022) %>%
  dplyr::select(geometry)

# business complaints and violations calls
business_complaints <- read_csv("Data/Data_311/business_complaints.csv")
sick_leave_violations <- read_csv("Data/Data_311/paid_sick_leave_violations.csv")
wage_complaints <- read_csv("Data/Data_311/wage_complaints.csv")

business <- rbind(business_complaints, sick_leave_violations, wage_complaints) %>%
  dplyr::filter(is.na(LOCATION) != TRUE,
                STATUS != "Canceled",
                DUPLICATE == "FALSE") %>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE")) %>%
  st_set_crs(4326) %>%
  mutate(date = mdy_hms(CREATED_DATE)) %>%
  mutate(year = year(date)) %>%
  filter(year == 2021 | year == 2022) %>%
  dplyr::select(year, geometry) %>%
  st_transform(ileast)

business2021 <- business %>%
  filter(year == 2021) %>%
  dplyr::select(geometry)

business2022 <- business %>%
  filter(year == 2022) %>%
  dplyr::select(geometry)

# violent crimes
violent <- read_csv("data/Violence_Reduction_-_Victims_of_Homicides_and_Non-Fatal_Shootings_20231018.csv") %>%
  dplyr::select(DATE, LATITUDE, LONGITUDE) %>%
  mutate(DATE = mdy_hms(DATE)) %>%
  mutate(year = year(DATE)) %>%
  filter(year == 2021 | year == 2022)%>%
    dplyr::select(year, Y = LATITUDE, X = LONGITUDE) %>%
    na.omit() %>%
    st_as_sf(coords = c("X", "Y"), crs = 4326, agr = "constant") %>%
  st_transform(ileast) %>%
    dplyr::select(year, geometry)

violent2021 <- violent %>%
  filter(year == 2021) %>%
  dplyr::select(geometry)

violent2022 <- violent %>%
  filter(year == 2022) %>%
  dplyr::select(geometry)


```



US Census Bureau ACS

Google Earth Engine

## Feature Engineering and Data Exploration

### Feature Engineering 

```{r feature engineering 2022}

# 2021 independent, 2022 dependent
inspections_2022 <- inspections %>%
  filter(year == 2022) 

inspections_2022 <- inspections_2022 %>%
  left_join(inspections_pre2022, ., by="license_num") %>%
  dplyr::filter(is.na(Location) == FALSE,
                license_num > 0) %>%
  st_as_sf()

inspections_2022$violent_buffer <- inspections_2022 %>% 
    st_buffer(250) %>% 
    aggregate(mutate(violent2021, counter = 1),., sum) %>%
    pull(counter)

inspections_2022$rats_buffer <- inspections_2022 %>% 
    st_buffer(250) %>% 
    aggregate(mutate(rats2021, counter = 1),., sum) %>%
    pull(counter)

inspections_2022$sanitation_buffer <- inspections_2022 %>% 
    st_buffer(250) %>% 
    aggregate(mutate(sanitation2021, counter = 1),., sum) %>%
    pull(counter)

inspections_2022$building_buffer <- inspections_2022 %>% 
    st_buffer(250) %>% 
    aggregate(mutate(building2021, counter = 1),., sum) %>%
    pull(counter)

inspections_2022$business_buffer <- inspections_2022 %>% 
    st_buffer(250) %>% 
    aggregate(mutate(business2021, counter = 1),., sum) %>%
    pull(counter)

inspections_2022$flooding_buffer <- inspections_2022 %>% 
    st_buffer(250) %>% 
    aggregate(mutate(flooding2021, counter = 1),., sum) %>%
    pull(counter)

inspections_2022$water_buffer <- inspections_2022 %>% 
    st_buffer(250) %>% 
    aggregate(mutate(water2021, counter = 1),., sum) %>%
    pull(counter)

inspections_2022 <- inspections_2022 %>%
  mutate(building_buffer = case_when(is.na(building_buffer) == TRUE ~ 0,
                                     is.na(building_buffer) == FALSE ~ building_buffer),
         water_buffer = case_when(is.na(water_buffer) == TRUE ~ 0,
                                  is.na(water_buffer) == FALSE ~ water_buffer),
         flooding_buffer = case_when(is.na(flooding_buffer) == TRUE ~ 0,
                                     is.na(flooding_buffer) == FALSE ~ flooding_buffer),
         business_buffer = case_when(is.na(business_buffer) == TRUE ~ 0,
                                     is.na(business_buffer) == FALSE ~ business_buffer),
         violent_buffer = case_when(is.na(violent_buffer) == TRUE ~ 0,
                                     is.na(violent_buffer) == FALSE ~ violent_buffer),
         rats_buffer = case_when(is.na(rats_buffer) == TRUE ~ 0,
                                     is.na(rats_buffer) == FALSE ~ rats_buffer),
         sanitation_buffer = case_when(is.na(sanitation_buffer) == TRUE ~ 0,
                                     is.na(sanitation_buffer) == FALSE ~ sanitation_buffer)
         )

coords <- st_coordinates(inspections_2022) 
neighborList <- knn2nb(knearneigh(coords, 3))
spatialWeights <- nb2listw(neighborList, style="W")
inspections_2022$lagfail <- lag.listw(spatialWeights, inspections_2022$fail_numeric)

chicagoCensus2021 <- 
  get_acs(geography = "tract", 
          variables = c("B19013_001", "B25002_003", "B25001_001", "B25058_001", "B01003_001", "B17001_002"), 
          year = 2021, 
          state = "IL", 
          geometry = TRUE, 
          county=c("Cook"),
          output = "wide") %>%
  rename(Med_Inc = B19013_001E,
         Total_Vacancy = B25002_003E,
         Total_Units = B25001_001E,
         Med_Rent = B25058_001E,
         Poverty = B17001_002E,
         Total_Pop = B01003_001E) %>%
  mutate(Percent_Vacancy = Total_Vacancy / Total_Units * 100,
         Percent_Poverty = Poverty / Total_Pop * 100) %>% 
  dplyr::select(Med_Inc, Percent_Vacancy, Med_Rent, Percent_Poverty, geometry) %>% 
  st_transform(ileast)

inspections_2022 <- st_join(inspections_2022, chicagoCensus2021, join = st_within)


```

```{r feature engineering 2023}

# 2021 independent, 2022 dependent
inspections_2023 <- inspections %>%
  filter(year == 2023) 

inspections_2023 <- inspections_2023 %>%
  left_join(inspections_pre2023, ., by="license_num") %>%
  dplyr::filter(is.na(Location) == FALSE,
                license_num > 0) %>%
  st_as_sf

inspections_2023$violent_buffer <- inspections_2023 %>% 
    st_buffer(250) %>% 
    aggregate(mutate(violent2022, counter = 1),., sum) %>%
    pull(counter)

inspections_2023$rats_buffer <- inspections_2023 %>% 
    st_buffer(250) %>% 
    aggregate(mutate(rats2022, counter = 1),., sum) %>%
    pull(counter)

inspections_2023$sanitation_buffer <- inspections_2023 %>% 
    st_buffer(250) %>% 
    aggregate(mutate(sanitation2022, counter = 1),., sum) %>%
    pull(counter)

inspections_2023$building_buffer <- inspections_2023 %>% 
    st_buffer(250) %>% 
    aggregate(mutate(building2022, counter = 1),., sum) %>%
    pull(counter)

inspections_2023$business_buffer <- inspections_2023 %>% 
    st_buffer(250) %>% 
    aggregate(mutate(business2022, counter = 1),., sum) %>%
    pull(counter)

inspections_2023$flooding_buffer <- inspections_2023 %>% 
    st_buffer(250) %>% 
    aggregate(mutate(flooding2022, counter = 1),., sum) %>%
    pull(counter)

inspections_2023$water_buffer <- inspections_2023 %>% 
    st_buffer(250) %>% 
    aggregate(mutate(water2022, counter = 1),., sum) %>%
    pull(counter)

inspections_2023 <- inspections_2023 %>%
  mutate(building_buffer = case_when(is.na(building_buffer) == TRUE ~ 0,
                                     is.na(building_buffer) == FALSE ~ building_buffer),
         water_buffer = case_when(is.na(water_buffer) == TRUE ~ 0,
                                  is.na(water_buffer) == FALSE ~ water_buffer),
         flooding_buffer = case_when(is.na(flooding_buffer) == TRUE ~ 0,
                                     is.na(flooding_buffer) == FALSE ~ flooding_buffer),
         business_buffer = case_when(is.na(business_buffer) == TRUE ~ 0,
                                     is.na(business_buffer) == FALSE ~ business_buffer),
         violent_buffer = case_when(is.na(violent_buffer) == TRUE ~ 0,
                                     is.na(violent_buffer) == FALSE ~ violent_buffer),
         rats_buffer = case_when(is.na(rats_buffer) == TRUE ~ 0,
                                     is.na(rats_buffer) == FALSE ~ rats_buffer),
         sanitation_buffer = case_when(is.na(sanitation_buffer) == TRUE ~ 0,
                                     is.na(sanitation_buffer) == FALSE ~ sanitation_buffer)
         )

coords <- st_coordinates(inspections_2023) 
neighborList <- knn2nb(knearneigh(coords, 3))
spatialWeights <- nb2listw(neighborList, style="W")
inspections_2023$lagfail <- lag.listw(spatialWeights, inspections_2023$fail_numeric)

chicagoCensus2022 <- 
  get_acs(geography = "tract", 
          variables = c("B19013_001", "B25002_003", "B25001_001", "B25058_001", "B01003_001", "B17001_002"), 
          year = 2022, 
          state = "IL", 
          geometry = TRUE, 
          county=c("Cook"),
          output = "wide") %>%
  rename(Med_Inc = B19013_001E,
         Total_Vacancy = B25002_003E,
         Total_Units = B25001_001E,
         Med_Rent = B25058_001E,
         Poverty = B17001_002E,
         Total_Pop = B01003_001E) %>%
  mutate(Percent_Vacancy = Total_Vacancy / Total_Units * 100,
         Percent_Poverty = Poverty / Total_Pop * 100) %>% 
  dplyr::select(Med_Inc, Percent_Vacancy, Med_Rent, Percent_Poverty, geometry) %>% 
  st_transform(ileast)

inspections_2023 <- st_join(inspections_2023, chicagoCensus2022, join = st_within)

```

### 2022 Inspections Maps

```{r map 2022}

inspections_2022_map <- inspections_2022 %>%
  group_by(neighborhood) %>%
  summarize(Total = n(),
            Failed = sum(fail_numeric)) %>%
  mutate(fail_rate = Failed/Total*100) 

neighborhoods_2022<-st_join(neighborhoods,inspections_2022_map)

ggplot()+
  geom_sf(data=neighborhoods_2022, aes(fill = Total))+
  scale_fill_viridis(option = "rocket", direction = -1)+
  labs(title = "Failed Inspections by Neighborhood",
       subtitle = "2022 (Count)",
       fill = "Count",
       caption = "Source: Chicago Data Portal") +
  theme(panel.grid = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_blank(),
        plot.title=element_text(size=14,face="bold", color = "white"),
        plot.subtitle = element_text(size=10,face="italic", color = "white"),
        plot.caption=element_text(size=8, color = "white"), 
        plot.background = element_rect(fill = 'black'))

ggsave(filename = "images/exploratory/neighborhood_fail_2022.png",
       width = 6)


ggplot()+
  geom_sf(data=neighborhoods_2022, aes(fill = fail_rate))+
  scale_fill_viridis(option = "rocket", direction = -1)+
  labs(title = "Failed Inspections by Neighborhood",
       subtitle = "2022 (Count)",
       fill = "Count",
       caption = "Source: Chicago Data Portal") +
  theme(panel.grid = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_blank(),
        plot.title=element_text(size=14,face="bold", color = "white"),
        plot.subtitle = element_text(size=10,face="italic", color = "white"),
        plot.caption=element_text(size=8, color = "white"), 
        plot.background = element_rect(fill = 'black'))

ggsave(filename = "images/exploratory/neighborhood_fail_2022_pct.png",
       width = 6)


```

### Plotting Predictor Correlations

```{r corrplot, fig.width=10}

vars_of_interest <- select_if(st_drop_geometry(inspections_2022), is.numeric) %>% 
  na.omit()

ggcorrplot(
  round(cor(vars_of_interest), 2), 
  p.mat = cor_pmat(vars_of_interest),
  colors = palette3,
  type="lower",
  insig = "blank",
  lab = TRUE,  # Ensure labels are shown
  lab_size = 2  # Adjust the size of the labels
    ) +  
    labs(title = "Correlation Across Numeric Variables") +
  theme(axis.text = element_text(size = 6 )) 

ggsave(filename = "images/exploratory/corrplot.png",
       width = 6)



```

### Plotting Relationships Between Inspection Results and Predictors

#### Categorical Variables - Bar Plots

##### Facility Type

```{r exploratory_binary1, message = FALSE, warning = FALSE}
inspections_2022 %>%
  st_drop_geometry() %>%
  dplyr::select(fail, facility_type) %>%
    gather(Variable, value, -fail) %>%
    count(Variable, value, fail) %>%
      ggplot(., aes(value, n, fill = fail)) +   
        geom_bar(position = "dodge", stat="identity") +
        scale_fill_manual(values = palette2) +
        labs(title = "Feature Associations with the Likelihood of <span style='color:#D1462F;'>Failing</span>",
             subtitle = "Counts of Facility Type") +
        theme(axis.text.x = element_text(size = 8),
              axis.title = element_blank(),
              panel.background = element_blank(),
              plot.title=element_markdown(size=14,face="bold"),
              plot.subtitle = element_text(size=10,face="italic"),
              plot.caption=element_text(size=8),
              legend.position = "none")

ggsave(filename = "images/exploratory/facilitytype.png",
       width = 6)
```

##### Neighborhood

```{r exploratory_binary1, message = FALSE, warning = FALSE}
inspections_2022 %>%
  st_drop_geometry() %>%
  dplyr::select(fail, neighborhood) %>%
    gather(Variable, value, -fail) %>%
    count(Variable, value, fail) %>%
      ggplot(., aes(value, n, fill = fail)) +   
        geom_bar(position = "dodge", stat="identity") +
        scale_fill_manual(values = palette2) +
        labs(title = "Feature Associations with the Likelihood of <span style='color:#D1462F;'>Failing</span>",
             subtitle = "Counts of Neighborhood") +
        theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust=0, size = 4),
              axis.title = element_blank(),
              panel.background = element_blank(),
              plot.title=element_markdown(size=14,face="bold"),
              plot.subtitle = element_text(size=10,face="italic"),
              plot.caption=element_text(size=8),
              legend.position = "none")

ggsave(filename = "images/exploratory/neighborhood.png",
       width = 6)

```


#### Continuous Variables - Bar Plots

##### Inspections and 311 Data

```{r exploratory_continuous1}
inspections_2022 %>%
  st_drop_geometry() %>%
  dplyr::select(fail, prior_fails, quarter, lagfail, rats_buffer, sanitation_buffer, building_buffer, business_buffer, flooding_buffer, water_buffer) %>%
  gather(Variable, value, -fail) %>%
    ggplot(aes(fail, value, fill=fail)) + 
      geom_bar(position = "dodge", stat = "summary", fun = "mean") + 
      facet_wrap(~Variable, scales = "free") +
      scale_fill_manual(values = palette2) +
        labs(title = "Feature Associations with the Likelihood of <span style='color:#D1462F;'>Failing</span>",
             subtitle = "Mean of Inspections and 311 Data Features") +
        theme(axis.text.x = element_text(size = 8),
              axis.title = element_blank(),
              panel.background = element_blank(),
              plot.title=element_markdown(size=14,face="bold"),
              plot.subtitle = element_text(size=10,face="italic"),
              plot.caption=element_text(size=8),
              legend.position = "none",
              strip.background =element_rect(fill= NA),
              strip.text = element_text(colour = "black", size = 10, face = "bold"))

ggsave(filename = "images/exploratory/insp_311.png",
       width = 6)
```

##### ACS, Google Earth Engine, and Chicago Crime Data

```{r exploratory_continuous2}
inspections_2022 %>%
  st_drop_geometry() %>%
  dplyr::select(fail, summer, winter, popdensity, Percent_Vacancy, Med_Rent, Percent_Poverty, violent_buffer) %>%
  gather(Variable, value, -fail) %>%
    ggplot(aes(fail, value, fill=fail)) + 
      geom_bar(position = "dodge", stat = "summary", fun = "mean") + 
      facet_wrap(~Variable, scales = "free") +
      scale_fill_manual(values = palette2) +
        labs(title = "Feature Associations with the Likelihood of <span style='color:#D1462F;'>Failing</span>",
             subtitle = "Mean of ACS, Google Earth Engine, Chicago Crime Data Features") +
        theme(axis.text.x = element_text(size = 8),
              axis.title = element_blank(),
              panel.background = element_blank(),
              plot.title=element_markdown(size=14,face="bold"),
              plot.subtitle = element_text(size=10,face="italic"),
              plot.caption=element_text(size=8),
              legend.position = "none",
              strip.background =element_rect(fill= NA),
              strip.text = element_text(colour = "black", size = 10, face = "bold"))

ggsave(filename = "images/exploratory/acs_google_crime.png",
       width = 6)

```


#### Continuous Variables - Density Plots

##### Inspections and 311 Data

```{r exploratory_continuous_density1, message = FALSE, warning = FALSE}
inspections_2022 %>%
  st_drop_geometry() %>%
    dplyr::select(fail,prior_fails, quarter, lagfail, rats_buffer, sanitation_buffer, building_buffer, business_buffer, flooding_buffer, water_buffer) %>%
    gather(Variable, value, -fail) %>%
    ggplot() + 
    geom_density(aes(value, color=fail), fill = "transparent") + 
    facet_wrap(~Variable, scales = "free") +
    scale_color_manual(values = palette2) +
        labs(title = "Feature Distributions of <span style='color:#D1462F;'>Failing</span>",
             subtitle = "Continuous Outcomes of Inspections Data Features") +
        theme(axis.text.x = element_text(size = 8),
              axis.title = element_blank(),
              panel.background = element_blank(),
              plot.title=element_markdown(size=14,face="bold"),
              plot.subtitle = element_text(size=10,face="italic"),
              plot.caption=element_text(size=8),
              legend.position = "none",
              strip.background =element_rect(fill= NA),
              strip.text = element_text(colour = "black", size = 10, face = "bold"))

ggsave(filename = "images/exploratory/insp_311_density.png",
       width = 6)
```

##### ACS, Google Earth Engine, and Chicago Crime Data

```{r exploratory_continuous_density2, message = FALSE, warning = FALSE}
inspections_2022 %>%
  st_drop_geometry() %>%
    dplyr::select(fail,summer, winter, popdensity, Percent_Vacancy, Med_Rent, Percent_Poverty, violent_buffer) %>%
    gather(Variable, value, -fail) %>%
    ggplot() + 
    geom_density(aes(value, color=fail), fill = "transparent") + 
    facet_wrap(~Variable, scales = "free") +
    scale_color_manual(values = palette2) +
        labs(title = "Feature Distributions of <span style='color:#D1462F;'>Failing</span>",
             subtitle = "Continuous Outcomes of Inspections Data Features") +
        theme(axis.text.x = element_text(size = 8),
              axis.title = element_blank(),
              panel.background = element_blank(),
              plot.title=element_markdown(size=14,face="bold"),
              plot.subtitle = element_text(size=10,face="italic"),
              plot.caption=element_text(size=8),
              legend.position = "none",
              strip.background =element_rect(fill= NA),
              strip.text = element_text(colour = "black", size = 10, face = "bold"))

ggsave(filename = "images/exploratory/acs_google_crime_density.png",
       width = 6)
```



## Spatial Process

neighborhoods, relationship to external spatial features

# Model

## Regression
```{r create_partition}

inspections_2022_model <- inspections_2022 %>%
  st_drop_geometry()

set.seed(440)
trainIndex <- createDataPartition(inspections_2022_model$fail, p = .50,
                                  list = FALSE,
                                  times = 1)

modelTrain <- inspections_2022_model[ trainIndex,]
modelTest  <- inspections_2022_model[ trainIndex,]

```

### Model 1
```{r run_model}

model1 <- glm(fail_numeric ~ .,
              data=modelTrain %>% 
                dplyr::select(fail_numeric, facility_type, Med_Rent, popdensity, winter, summer, Percent_Vacancy, neighborhood, quarter, rats_buffer, sanitation_buffer, violent_buffer, building_buffer, water_buffer, flooding_buffer, business_buffer, lagfail, prior_fails, Percent_Poverty),
                  family="binomial" (link="logit"))


summary(model1)

aic1 <- data.frame(model1$aic) %>%
  rename(Model1_AIC = "model1.aic")

```

### Model 2

```{r run_model}

model2 <- glm(fail_numeric ~ .,
                  data=modelTrain %>% 
                    dplyr::select(fail_numeric, facility_type, neighborhood, quarter, prior_fails, winter),
                  family="binomial" (link="logit"))

aic2 <- data.frame(model2$aic) %>%
  rename(Model2_AIC = "model2.aic")

cbind(aic1, aic2) %>% 
  kbl() %>%
  kable_minimal() %>% 
  kable_styling(full_width = FALSE)

```

## Density of Probabilities Plot

```{r testProbs}

testProbs <- data.frame(Outcome = as.factor(modelTest$fail_numeric),
                        Probs = predict(model1, modelTest, type= "response"))

results_test <- cbind(modelTest, testProbs)

ggplot(testProbs, aes(x = Probs, fill = as.factor(Outcome))) + 
  geom_density(color = NA) +
  facet_grid(Outcome ~ .) +
  scale_fill_manual(values = palette2) +
  labs(x = "Fail", y = "Density of probabilities",
       title = "Distribution of predicted probabilities by observed outcome (Pass/<span style='color:#D1462F;'>Fail</span>)") +
        theme(axis.text.x = element_text(size = 8),
              panel.background = element_blank(),
              plot.title=element_markdown(size=14,face="bold"),
              plot.subtitle = element_text(size=10,face="italic"),
              plot.caption=element_text(size=8),
              legend.position = "none",
              strip.background =element_rect(fill= NA),
              strip.text = element_text(colour = "black", size = 10, face = "bold"))


ggsave(filename = "images/model/dens_probs.png",
       width = 8)  

```

```{r thresholds}
testProbs <- 
  testProbs %>%
  mutate(predOutcome  = as.factor(ifelse(testProbs$Probs > 0.5 , 1, 0)))
```

```{r confusion_matrix, warning=FALSE}
caret::confusionMatrix(testProbs$predOutcome, testProbs$Outcome, 
                       positive = "1")

```

```{r auc, message = FALSE, warning = FALSE}
auc(testProbs$Outcome, testProbs$Probs)

```

```{r roc_curve, warning = FALSE, message = FALSE}
ggplot(testProbs, aes(d = as.numeric(Outcome), m = Probs)) +
  geom_roc(n.cuts = 50, labels = FALSE, colour = "#FE9900") +
  style_roc(theme = theme_bw) +
  geom_abline(slope = 1, intercept = 0, size = 1.5, color = 'grey') +
  labs(title = "ROC Curve - Model")

ggsave(filename = "images/model/roc.png",
       width = 8)  

```


## Cross Validation

```{r cv}
ctrl <- trainControl(method = "cv", number = 50, classProbs=TRUE, summaryFunction=twoClassSummary)


inspections_2022_model <- inspections_2022_model %>%
  st_drop_geometry() %>%
  na.omit()


cvFit <- train(fail ~ .,
                  data=inspections_2022_model %>% 
                    dplyr::select(fail, facility_type, Med_Rent, popdensity, winter, summer, Percent_Vacancy, neighborhood, quarter, rats_buffer, sanitation_buffer, violent_buffer, building_buffer, water_buffer, flooding_buffer, business_buffer, lagfail, prior_fails, Percent_Poverty), 
                method="glm", family="binomial",
                metric="ROC", trControl = ctrl)

cvFit
```

```{r goodness_metrics, message = FALSE, warning = FALSE}
dplyr::select(cvFit$resample, -Resample) %>%
  gather(metric, value) %>%
  left_join(gather(cvFit$results[2:4], metric, mean)) %>%
  ggplot(aes(value)) + 
    geom_histogram(bins=35, fill = "#FF006A") +
    facet_wrap(~metric) +
    geom_vline(aes(xintercept = mean), colour = "#981FAC", linetype = 3, size = 1.5) +
    scale_x_continuous(limits = c(0, 1)) +
    labs(x="Goodness of Fit", y="Count", title="CV Goodness of Fit Metrics",
         subtitle = "Across-fold mean reprented as dotted lines")+
        theme(axis.text.x = element_text(size = 8),
              panel.background = element_blank(),
              panel.border = element_rect(color = "grey", fill = NA),
              plot.title=element_markdown(size=14,face="bold"),
              plot.subtitle = element_text(size=10,face="italic"),
              plot.caption=element_text(size=8),
              legend.position = "none",
              strip.background =element_rect(fill= NA),
              strip.text = element_text(colour = "black", size = 10, face = "bold"))


ggsave(filename = "images/model/cv.png",
       width = 8)  

```

## Predictions
2023 dependent, 2022 independent

```{r predictions}

inspections_2023_model <- inspections_2023 %>%
  filter(neighborhood != "Burnside") %>%
  st_drop_geometry()

testProbs2 <- data.frame(Probs = predict(model1, inspections_2023_model, type= "response"))

results <- cbind(inspections_2023_model, testProbs2)

results$clean_coords <- gsub(pattern = '[()]', 
replacement = '', x = results$Location)

split_coords <- str_split(string = results$clean_coords, 
pattern = ',', n = 2, simplify = TRUE)

results <- cbind(results, split_coords) %>%
  rename(lat = "1",
         lon = "2")

results <- results %>%
  st_as_sf(coords = c("lon", "lat")) %>%
  st_set_crs(4326) %>%
  st_transform(ileast)

results_plot <- results %>%
  mutate(bins = case_when(Probs < .1 ~ "0-10%",
                          Probs >= .1 & Probs < .2 ~ "10-20%",
                          Probs >= .2 & Probs < .3 ~ "20-30%",
                          Probs >= .3 & Probs < .4 ~ "30-40%",
                          Probs >= .4 & Probs < .5 ~ "40-50%",
                          Probs >= .5 & Probs < .6 ~ "50-60%",
                          Probs >= .6 & Probs < .7 ~ "60-70%",
                          Probs >= .7 & Probs < .8 ~ "70-80%",
                          Probs >= .8 & Probs < .9 ~ "80-90%",
                          Probs >= .9 & Probs < 1 ~ "90-100%")) %>%
  na.omit()


ggplot()+
  geom_bar(data = results_plot, aes(bins))+
        labs(title = "Distribution of Fail Risk Probability",
             subtitle = "2023 Predictions") +
        theme(axis.text.x = element_text(size = 8),
              axis.title = element_blank(),
              panel.background = element_blank(),
              plot.title=element_markdown(size=14,face="bold"),
              plot.subtitle = element_text(size=10,face="italic"),
              plot.caption=element_text(size=8),
              legend.position = "none",
              strip.background =element_rect(fill= NA),
              strip.text = element_text(colour = "black", size = 10, face = "bold"))

ggsave(filename = "images/predict/bar.png",
       width = 8)  

```


# Application

## Facility Risk by Points

```{r app map}

wrigleyville <- neighborhoods %>%
  dplyr::filter(pri_neigh == "Wrigleyville")

bounds <- st_bbox(st_buffer(wrigleyville, 1000))  %>%
  st_as_sfc %>%
  st_crop(neighborhoods, .)

# streets
streets <- st_read("Data/streets.geojson")%>%
  st_transform(ileast)

streets_wrigleyville <- st_crop(streets, bounds)

wrigleyville_bounds_points <- results %>%
  st_crop(., bounds)

wrigleyville_points <- results %>%
  st_crop(., wrigleyville)

ggplot()+
  geom_sf(data = bounds, fill = NA, color = "grey90")+
  geom_sf(data = streets_wrigleyville, color = "grey70", lwd = 1)+
  geom_sf(data = streets_wrigleyville, color = "white", fill = NA, lwd = .2)+
  geom_sf(data = wrigleyville, fill = "lightblue", color = "slateblue1", lwd=1.5, alpha = .2)+
  geom_sf(data = wrigleyville_bounds_points, aes(color = Probs), size = 3, alpha = .75)+
  scale_color_viridis(option = "rocket", direction = -1)+
  labs(title = "Wrigleyville",
       subtitle = "Health Inspection Failure Risk",
       color = "Fail\nChance",
       caption = "powered by ia") +
  theme(legend.position="bottom",
        legend.title = element_text(size = 10, hjust= .5, vjust = 1),
        panel.grid = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_blank(),
        plot.title=element_text(size=16,face="bold", color = "black"),
        plot.subtitle = element_text(size=10,face="italic", color = "black"),
        plot.caption=element_text(size=8, color = "black"))

ggsave(filename = "images/app/wrigleyville.png",
       width = 8)  

```

## Facility Risk by Neighborhoods

```{r app map2}
results_neighborhoods <- results %>% 
  group_by(neighborhood) %>%
  summarize(total = n(),
            probability = mean(Probs))
  

results_neighborhood_map <- st_join(neighborhoods, results_neighborhoods)
  
ggplot(data=results_neighborhood_map)+
  geom_sf(aes(fill = probability), color = NA)+
  scale_fill_viridis(option = "rocket", direction = -1)+
  labs(title = "Predicted Fail Risk by Neighborhood",
       subtitle = "2023 (Average; Probability)",
       fill = "Probability",
       caption = "Source: Chicago Data Portal") +
  theme(panel.grid = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_blank(),
        plot.title=element_text(size=14,face="bold", color = "white"),
        plot.subtitle = element_text(size=10,face="italic", color = "white"),
        plot.caption=element_text(size=8, color = "white"), 
        plot.background = element_rect(fill = 'black'))

ggsave(filename = "images/app/neighborhoods_predict_23.png",
       width = 8)  

```

### Comparison to 2023 Inspections Failures

```{r maps comp}

ggplot(data=neighborhoods_count2023)+
  geom_sf(aes(fill = Total), color = NA)+
  scale_fill_viridis(option = "rocket", direction = -1)+
  labs(title = "Failed Inspections by Neighborhood",
       subtitle = "2023 (Count)",
       fill = "Count",
       caption = "Source: Chicago Data Portal") +
  theme(panel.grid = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_blank(),
        plot.title=element_text(size=14,face="bold", color = "white"),
        plot.subtitle = element_text(size=10,face="italic", color = "white"),
        plot.caption=element_text(size=8, color = "white"), 
        plot.background = element_rect(fill = 'black'))

ggsave(filename = "images/app/neighborhoods_23.png",
       width = 8)  

ggplot(data=neighborhoods_count2023)+
  geom_sf(aes(fill = fail_rate), color = NA)+
  scale_fill_viridis(option = "rocket", direction = -1)+
  labs(title = "Failed Inspections by Neighborhood",
       subtitle = "2023 (Percent)",
       fill = "Percent",
       caption = "Source: Chicago Data Portal") +
  theme(panel.grid = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_blank(),
        plot.title=element_text(size=14,face="bold", color = "white"),
        plot.subtitle = element_text(size=10,face="italic", color = "white"),
        plot.caption=element_text(size=8, color = "white"), 
        plot.background = element_rect(fill = 'black'))

ggsave(filename = "images/app/neighborhoods_23_pct.png",
       width = 8)  




```

# Conclusion

## Model Refinement 

Incorporate more internal characteristics of restaurants

Use text mining and sentiment analysis on online reviews and violations column data

Meeting the use case
