---
title: "MUSA508_Final"
author: "Oliver Atwood, Dave Drennan"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages}

library(tidyverse)
library(tidycensus)
library(sf)
library(kableExtra)
library(caret)
library(knitr) 
library(pscl)
library(plotROC)
library(pROC)
library(lubridate)
library(gridExtra)
library(cowplot)
library(raster)
library(sp)

source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

options(scipen = 999)

census_api_key("e13d5be5cb48d927009e0dca0af99d21918d514f")

palette5 <- c("#981FAC","#CB0F8B","#FF006A","#FE4C35","#FE9900")
palette4 <- c("#981FAC","#FF006A","#FE4C35","#FE9900")
palette2 <- c("#981FAC","#FF006A")

ileast <- "epsg:3435"

```

# Data

```{r inspections data}

inspections_all <- read_csv("Data/Food_Inspections_-_7_1_2018_-_Present.csv")

inspections_all$date <- mdy(inspections_all$`Inspection Date`)
inspections_all$year <- year(inspections_all$date)

inspections <- inspections_all %>%
  dplyr::filter(year == 2021 | year == 2022,
                Results != "No Entry" & Results != "Out of Business" & Results != "Not Ready",
                is.na(Location) == FALSE,
                is.na(Risk) == FALSE) %>%
  rename(insp_type = "Inspection Type") %>%
  mutate(Type = case_when( insp_type == "Canvass" ~ "Canvass",
                           insp_type == "Complaint" ~ "Complaint",
                           insp_type == "License" ~ "License",
                           insp_type == "Canvass Re-Inspection" |
                             insp_type == "Complaint Re-Inspection" |
                             insp_type == "License Re-Inspection" ~ "Re-Inspections",
                           insp_type == "NO ENTRY" |
                             insp_type == "Non-Inspection" |
                             insp_type == "Recent Inspection" |
                             insp_type == "Short Form Complaint" |
                             insp_type == "Special Events (Festivals)" |
                             insp_type == "Suspected Food Poisoning" |
                             insp_type == "Suspected Food Poisoning Re-inspection" ~ "Other"),
         fail_numeric = case_when(Results == "Pass" ~ 0,
                   Results == "Pass w/ Conditions" ~ 0,
                   Results != "Pass" ~ 1),
         fail = case_when(Results == "Pass" ~ "No",
                   Results == "Pass w/ Conditions" ~ "No",
                   Results != "Pass" ~ "Yes"),
         )

inspections <- inspections %>%
  st_as_sf(coords = c("Longitude", "Latitude")) %>%
  st_set_crs(4326) %>%
  st_transform(ileast)

ggplot()+
  geom_sf(data = inspections)

#inspections <- write.csv(inspections_final)
```

```{r external data}


```

```{r get census data, message=FALSE, warning=FALSE, cache=TRUE, results = 'hide'}
chicagoCensus <- 
  get_acs(geography = "tract", 
          variables = c("B19013_001", "B25002_003", "B25001_001"), 
          year = 2020, 
          state = "IL", 
          geometry = TRUE, 
          county=c("Cook"),
          output = "wide") %>%
  rename(Med_Inc = B19013_001E,
         Total_Vacancy = B25002_003E,
         Total_Units = B25001_001E) %>%
  mutate(Percent_Vacancy = Total_Vacancy / Total_Units) %>% 
  dplyr::select(Med_Inc, Percent_Vacancy, GEOID, geometry)

```


```{r join census data to inspections points, message = FALSE, warning = FALSE}
dat_census <- st_join(inspections %>%
          filter(is.na(from_longitude) == FALSE &
                   is.na(from_latitude) == FALSE &
                   is.na(to_latitude) == FALSE &
                   is.na(to_longitude) == FALSE) %>%
          st_as_sf(., coords = c("from_longitude", "from_latitude"), crs = 4326),
        chicagoTracts %>%
          st_transform(crs=4326),
        join=st_intersects,
              left = TRUE) %>%
  rename(Origin.Tract = GEOID) %>%
  mutate(from_longitude = unlist(map(geometry, 1)),
         from_latitude = unlist(map(geometry, 2)))%>%
  as.data.frame() %>%
  dplyr::select(-geometry)%>%
  st_as_sf(., coords = c("to_longitude", "to_latitude"), crs = 4326) %>%
  st_join(., chicagoTracts %>%
            st_transform(crs=4326),
          join=st_intersects,
          left = TRUE) %>%
  rename(Destination.Tract = GEOID)  %>%
  mutate(to_longitude = unlist(map(geometry, 1)),
         to_latitude = unlist(map(geometry, 2)))%>%
  as.data.frame() %>%
  dplyr::select(-geometry)
```



```{r extract raster data to points}
# Read the infrared data file
summer_thermal <- raster('Data/Landsat9_Thermal_Composite_Chicago.tif')
winter_thermal <- raster('Data/Landsat9_Thermal_Composite2_Chicago.tif')
pop_raster <- raster('Data/Pop_2020_Chicago.tif')

# Summer Thermal
# Extract raster values
extracted_values <- extract(summer_thermal, inspections)
# Add the extracted values to the 'inspections' dataset
inspections[[summer_thermal]] <- extracted_values

# Winter Thermal
extracted_values <- extract(winter_thermal, inspections)
inspections[[summer_thermal]] <- extracted_values

# Population
extracted_values <- extract(pop_raster, inspections)
inspections[[summer_thermal]] <- extracted_values


```


## Data Exploration

```{r data vis}

inspections <- inspections %>%
  st_drop_geometry()

inspections %>%
    dplyr::select(fail, Risk, Type) %>%
    gather(Variable, value, -fail) %>%
    count(Variable, value, fail) %>%
      ggplot(., aes(value, n, fill = fail)) +   
        geom_bar(position = "dodge", stat="identity") +
        facet_wrap(~Variable, scales="free") +
        scale_fill_manual(values = palette2) +
        labs(x="Fail", y="Value",
             title = "Feature associations with the likelihood of Fail",
             subtitle = "Categorical features") +
        theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

## Feature Engineering

# Model

```{r create_partition}

inspections_2021 <- inspections %>%
  dplyr::filter(year == 2021)


set.seed(1234)
trainIndex <- createDataPartition(inspections_2021$fail, p = .50,
                                  list = FALSE,
                                  times = 1)
modelTrain <- inspections_2021[ trainIndex,]
modelTest  <- inspections_2021[-trainIndex,]

```

```{r run_model}

model <- glm(fail_numeric ~ .,
                  data=modelTrain %>% 
                    dplyr::select(fail_numeric, Risk, Type),
                  family="binomial" (link="logit"))

summary(model)

```
```{r testProbs}

testProbs <- data.frame(Outcome = as.factor(modelTest$fail_numeric),
                        Probs = predict(model, modelTest, type= "response"))

ggplot(testProbs, aes(x = Probs, fill = as.factor(Outcome))) + 
  geom_density() +
  facet_grid(Outcome ~ .) +
  scale_fill_manual(values = palette2) +
  labs(x = "Fail", y = "Density of probabilities",
       title = "Distribution of predicted probabilities by observed outcome") +
  theme(strip.text.x = element_text(size = 18),
        legend.position = "none")
```

```{r thresholds}
testProbs <- 
  testProbs %>%
  mutate(predOutcome  = as.factor(ifelse(testProbs$Probs > 0.5 , 1, 0)))
```

```{r confusion_matrix}
caret::confusionMatrix(testProbs$predOutcome, testProbs$Outcome, 
                       positive = "1")

```

```{r auc, message = FALSE, warning = FALSE}
auc(testProbs$Outcome, testProbs$Probs)
```
```{r roc_curve, warning = FALSE, message = FALSE}
ggplot(testProbs, aes(d = as.numeric(Outcome), m = Probs)) +
  geom_roc(n.cuts = 50, labels = FALSE, colour = "#FE9900") +
  style_roc(theme = theme_grey) +
  geom_abline(slope = 1, intercept = 0, size = 1.5, color = 'grey') +
  labs(title = "ROC Curve - Model")
```

```{r cv}
ctrl <- trainControl(method = "cv", number = 100, classProbs=TRUE, summaryFunction=twoClassSummary)

#Not running, "missing values in object"

cvFit <- train(fail ~ .,
                  data=inspections %>% 
                    dplyr::select(fail, Risk), 
                method="glm", family="binomial",
                metric="ROC", trControl = ctrl)

cvFit
```

```{r goodness_metrics, message = FALSE, warning = FALSE}
dplyr::select(cvFit$resample, -Resample) %>%
  gather(metric, value) %>%
  left_join(gather(cvFit$results[2:4], metric, mean)) %>%
  ggplot(aes(value)) + 
    geom_histogram(bins=35, fill = "#FF006A") +
    facet_wrap(~metric) +
    geom_vline(aes(xintercept = mean), colour = "#981FAC", linetype = 3, size = 1.5) +
    scale_x_continuous(limits = c(0, 1)) +
    labs(x="Goodness of Fit", y="Count", title="CV Goodness of Fit Metrics",
         subtitle = "Across-fold mean reprented as dotted lines")

```
